/*! chaas - v0.2.0 - 2017-05-19
* https://github.com/behappyrightnow/chaas
 Licensed  */
function applyConstruct(a,b){function c(){function b(){}return b.prototype=a.prototype,new b}var d,e;return"function"==typeof Object.create?d=Object.create(a.prototype):{}.__proto__?(d={},d.__proto__=a.prototype,d.__proto__!==a.prototype&&(d=c())):d=c(),d.constructor=a,e=a.apply(d,b),"object"==typeof e&&(d=e),d}function mockHttp(a){return{success:function(){return mockHttp(a)},error:function(){return mockHttp(a)}}}angular.module("chaas",["ngRoute"]).config(["$routeProvider",function(a){a.when("/:page",{controller:"FitController",controllerAs:"fit",templateUrl:"/app/views/page.html"}).otherwise({redirectTo:"/HomePage"})}]);var FitController=function(){function a(a,b,c){var d=this;c.then(function(){d.config=c,d.loadData(a,b.page)}),this.editMode=!1,this.rawText="",this.$http=a}return a.prototype.loadData=function(a,b){this.pageTitle=b;var c=this;console.log("Loading data from "+this.config.path(this.config.wiki,b)),a({method:"GET",url:this.config.path(this.config.wiki,b)}).success(function(b){c.rawText=b;var d=b.split("\n");c.pageContents=fitUtils.wikiData(d,a)}).error(function(){console.log("error!")})},a.prototype.runFitTestsOnPage=function(){var a=this;console.log("Running fit tests");var b=_.filter(this.pageContents,function(a){return"TABLE"===a.type});_.each(b,function(b){a.process(b)})},a.prototype.process=function(a){var b=this.createProcessor(a.firstRow());b.process(a)},a.prototype.createProcessor=function(a){if(1===a.length)return new DecisionProcessor(fitUtils);var b=a[0].cellEntry.toUpperCase();if(-1!==b.indexOf("QUERY"))return new QueryProcessor(fitUtils);if(-1!==b.indexOf("SCRIPT"))return new ScriptProcessor(fitUtils);throw"Could not understand which Processor needs to be instantiated!"},a.prototype.editPage=function(){this.editMode=!0},a.prototype.savePage=function(){var a=this.rawText.split("\n");this.pageContents=fitUtils.wikiData(a,this.$http),this.editMode=!1,console.log(this.pageTitle),console.log(this.rawText);var b={name:this.pageTitle,contents:this.rawText};jQuery.post("/page",b).done(function(){console.log("Done posting data")})},a.prototype.pasteContent=function(a){var b=new PasteProcessor(a);b.process(),void 0!==b.rows&&b.rows.length>0&&(this.rawText+="\n");for(var c=0;c<b.rows.length;c++){for(var d=b.rows[c],e="|",f=0;f<d.length&&""!==d[f];f++)e+=d[f],f>=0&&f<d.length&&(e+="|");this.rawText+=e+"\n"}this.savePage(),console.log("Pasted ",b.rows)},a}();angular.module("chaas").controller("FitController",FitController),function(){angular.module("chaas").directive("chaasFixture",function(){return{restrict:"E",controller:["CONFIG","$http","$element","$scope",function(a,b,c,d){d.processListing=function(a,b){_.each(a.split("\n"),function(a){/.js$/.test(a)&&c.append($("<script>",{type:"text/javascript",src:b+a}))})},a.then(function(){var c=new Array;c=a.logic.concat(a.fixtures);for(var e=0;e<c.length;e++){var f=c[e];!function(a){b.get(a).success(function(b){d.processListing(b,a)})}(f)}})}]}})}();var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Processor=function(){function a(a){this.fitUtils=a}return a.prototype.initializeClass=function(a,b){var c=void 0;try{var c=new window[a];b.status="PASSED"}catch(d){void 0===c?(b.status="FAILED",b.msg="Class '"+a+"' not found. Please include src file '"+a+".js' and make sure it contains a class called "+a+"."):b.status="PASSED"}return c},a.prototype.process=function(){throw"Can't call Processor directly. Please extend in subclass."},a}(),DecisionProcessor=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.process=function(a){var b=a.firstRow(),c=this.fitUtils.camelCaseClass(b[0].cellEntry),d=this.initializeClass(c,b[0]);this.processTable(a,d,c)},b.prototype.processTable=function(a,b,c){var d=this.processMethods(a,b,c);this.processRows(a,d,b)},b.prototype.processMethods=function(a,b,c){for(var d=a.rows[1],e=new Array,f=0;f<d.length;f++){var g,h=d[f],i=h.cellEntry;g=this.hasQuestionMark(i)?this.createOutputMethod(i):this.createInputMethod(i),e.push(g),void 0===b[g.methodName]?(h.status="FAILED",h.msg=c+": No method called '"+g.methodName+"'. Either initialize in constructor or provide a function with this name."):h.status="PASSED"}return e},b.prototype.processRows=function(a,b,c){for(var d=2;d<a.rows.length;d++){for(var e=a.rows[d],f=0;f<e.length;f++){var g=e[f],h=b[f];h.isInput&&h.passInput(c,g.cellEntry)}void 0!==c.execute&&"function"==typeof c.execute&&c.execute();for(var f=0;f<e.length;f++){var g=e[f],h=b[f];if(!h.isInput){var i=h.fetchOutput(c);i==g.cellEntry?g.status="PASSED":(g.status="FAILED",g.msg=null,g.expected=g.cellEntry,g.actual=i)}}}},b.prototype.hasQuestionMark=function(a){return-1!==a.indexOf("?")},b.prototype.createInputMethod=function(a){return new Method(a,!0)},b.prototype.createOutputMethod=function(a){a=a.substr(0,a.length-1);var b=new Method(a,!1);return b},b}(Processor),QueryProcessor=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.process=function(a){var b=a.firstRow(),c=b[0].cellEntry,d=c.indexOf(":");c=c.substr(d+1),c=this.fitUtils.camelCaseClass(c);var e=this.initializeClass(c,b[0]);this.checkQueryMethodIn(e,b,c);var f=this.callQueryMethod(e,b),g=this.processFieldHeadersIn(a);this.processRows(a,g,f)},b.prototype.checkQueryMethodIn=function(a,b,c){var d=b[1];void 0===a.query?(d.status="FAILED",d.msg="Method query() not found in class "+c):d.status="PASSED"},b.prototype.callQueryMethod=function(a,b){var c=b[1].cellEntry;return a.query(c)},b.prototype.processFieldHeadersIn=function(a){return _.pluck(a.rows[1],"cellEntry")},b.prototype.matchedRow=function(a,b,c){for(var d=0,e=-1,f=2;f<c.rows.length;f++)for(var g=c.rows[f],h=0,i=0;i<b.length;i++){var j=a[b[i]],k=g[i].cellEntry;j==k&&(h++,h>d&&(d=h,e=f))}return e},b.prototype.processRows=function(a,b,c){for(var d=this.matchResultsToTableAndReturnSurplus(c,b,a),e=2;e<a.rows.length;e++){var f=a.rows[e];this.processRow(f,c,b)}this.processSurplusRows(d,c,b,a)},b.prototype.processSurplusRows=function(a,b,c,d){for(var e=0;e<a.length;e++){var f=b[a[e]];this.processSurplusRow(c,f,d)}},b.prototype.processSurplusRow=function(a,b,c){for(var d=new Array,e=0;e<a.length;e++){var f=b[a[e]];d.push(new CellWikiElement(f))}d[0].status="IGNORED",d[0].msg="surplus",c.rows.push(d)},b.prototype.processRow=function(a,b,c){var d=a[0].foundIndex;if(void 0!==d)for(var e=b[d],f=0;f<c.length;f++)""!==a[f].cellEntry?a[f].cellEntry===e[c[f]]?a[f].status="PASSED":(a[f].status="FAILED",a[f].expected=a[f].cellEntry,a[f].actual=e[c[f]]):(a[f].status="IGNORED",a[f].actual=e[c[f]]);else a[0].status="FAILED",a[0].msg="missing"},b.prototype.matchResultsToTableAndReturnSurplus=function(a,b,c){for(var d=new Array,e=0;e<a.length;e++){var f=a[e],g=this.matchedRow(f,b,c);-1!==g?c.rows[g][0].foundIndex=e:d.push(e)}return d},b}(Processor),ScriptProcessor=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.process=function(a){var b=a.firstRow(),c=b[1].cellEntry;c=this.fitUtils.camelCaseClass(c);for(var d=new Array,e=2;e<b.length;e++)d.push(b[e].cellEntry);var f=this.callConstructor(c,d,b),g=["reject","check","note","check not","ensure","show"];this.processRows(a,g,f)},b.prototype.callConstructor=function(a,b,c){try{var d=null;if(-1!==a.indexOf(".")){var e=a.split(".");d=window[e[0]];for(var f=1;f<e.length;f++)d=d[e[f]]}else d=window[a];var g=applyConstruct(d,b);console.log(c,c.length);for(var h=2;h<c.length;h++)c[h].status="PASSED";return g}catch(i){for(var f=2;f<c.length;f++)c[f].status="FAILED",c[f].msg="Exception thrown "+i}},b.prototype.processRows=function(a,b,c){for(var d=a.rows,e=1;e<d.length;e++){var f=d[e];this.processRow(f,b,c)}},b.prototype.processRow=function(a,b,c){var d=a[0],e=d.cellEntry;if(-1!==b.indexOf(e))e=this.fitUtils.camelCase(e),this.isReservedWord(e)?this[e](c,a):(d.status="IDLE",d.msg="reserved word: "+e);else{var f=this.methodFromRow(a);this.runRowTest(a[0],f,c,!0,!1)}},b.prototype.isReservedWord=function(a){return void 0!==this[a]},b.prototype.runRowTest=function(a,b,c,d,e){var f=b.argsArray,g=b.method;if(void 0!==c[g.methodName]){var h=null;h="function"==typeof c[g.methodName]?c[g.methodName].apply(c,f):c[g.methodName];var i=e?h!=d:h==d;i?this.methodPassed(a,g):this.methodFailed(a,g,h)}else this.methodDoesNotExist(a,g)},b.prototype.check=function(a,b){var c=this.methodFromRow(b.slice(1,b.length-1)),d=b[b.length-1];this.runRowTest(d,c,a,d.cellEntry,!1)},b.prototype.checkNot=function(a,b){var c=this.methodFromRow(b.slice(1,b.length-1)),d=b[b.length-1];this.runRowTest(d,c,a,d.cellEntry,!0)},b.prototype.reject=function(a,b){var c=this.methodFromRow(b.slice(1));this.runRowTest(b[0],c,a,!1,!1)},b.prototype.ensure=function(a,b){var c=this.methodFromRow(b.slice(1));this.runRowTest(b[0],c,a,!0,!1)},b.prototype.show=function(a,b){var c=this.methodFromRow(b.slice(1)),d=c.method,e=c.argsArray;if(void 0!==a[d.methodName]){var f=a[d.methodName].apply(a,e),g=new CellWikiElement(f+"");g.status="SHOW",console.log(f),b.push(g)}},b.prototype.methodFromRow=function(a){var b=a[0].cellEntry,c=[];if(";"!=b[b.length-1]){a.length>1&&c.push(a[1].cellEntry);for(var d=2;d<a.length;d+=2){var e=a[d+1],f=a[d];c.push(e.cellEntry),b=b+" "+f.cellEntry}}else{for(var d=1;d<a.length;d++){var e=a[d];c.push(e.cellEntry)}b=b.replace(";","")}var g=this.createMethod(b);return{argsArray:c,method:g}},b.prototype.methodFailed=function(a,b,c){a.status="FAILED",a.msg=b.methodName+" failed. Got: "+c},b.prototype.methodPassed=function(a,b){a.status="PASSED",a.msg="found method: "+b.methodName},b.prototype.methodDoesNotExist=function(a,b){a.status="FAILED",a.msg="couldn't find method: "+b.methodName},b.prototype.createMethod=function(a){return new Method(a,!0)},b}(Processor),__extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},FitUtils=function(){function a(){}return a.prototype.capitalized=function(a){return a.charAt(0).toUpperCase()+a.slice(1)},a.prototype.camelCaseClass=function(a){for(var b=a.split(" "),c="",d=0;d<b.length;d++)c+=this.capitalized(b[d]);return c},a.prototype.camelCase=function(a){if(-1===a.indexOf(" "))return a;for(var b=a.split(" "),c=b[0],d=1;d<b.length;d++)c+=this.capitalized(b[d]);return c},a.prototype.wikiData=function(a,b){var c,d=!1,e=new Array;return a.forEach(function(a){d?d&&("|"!==a.charAt(0)?(d=!1,e.push(c),c=null,e.push(new DefaultElement(a,b))):c.addRow(a)):"|"===a.charAt(0)?(d=!0,c=new TableWikiElement,c.addRow(a)):e.push(new DefaultElement(a,b))}),null!==c&&void 0!==c&&e.push(c),e},a}(),DefaultElement=function(){function a(a,b){this.contents=new Array,this.type="DEFAULT",this.process(a,b)}return a.prototype.process=function(a,b){var c=new WikiState.MinusOne("",""),d=new Array;c.transition(d,a,0);for(var e=0;e<d.length;e++)this.contents.push(d[e].createAtomicElement(b))},a}(),WikiState;!function(a){var b=function(){function a(a,b){this.text=a,this.oldText=b}return a.prototype.transition=function(a,b,c){var d=b[c];if(void 0===d)return void this.endInputTransition(a);var e=this.nextState(a,d);c<b.length-1?e.transition(a,b,c+1):e.endInputTransition(a)},a.prototype.endInputTransition=function(){throw"Can't call directly"},a.prototype.nextState=function(){throw"Can't call directly"},a.prototype.createAtomicElement=function(){throw"Can't call directly"},a}();a.State=b;var c=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.nextState=function(a,c){return c>="A"&&"Z">=c?new d(c,this.text):new b(this.text+c,"")},b.prototype.endInputTransition=function(a){a.push(this)},b.prototype.createAtomicElement=function(){return-1!==this.text.toUpperCase().indexOf(".PNG")?new ImageElement(this.text):new TextElement(this.text)},b}(b);a.MinusOne=c;var d=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.nextState=function(a,b){return b>="a"&&"z">=b?new e(this.text+b,this.oldText):new c(this.oldText+this.text+b,"")},b.prototype.endInputTransition=function(a){a.push(new c(this.oldText,""))},b}(b);a.Zero=d;var e=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.nextState=function(a,d){return d>="a"&&"z">=d?new b(this.text+d,this.oldText):d>="A"&&"Z">=d?new f(this.text+d,this.oldText):new c(this.oldText+this.text+d,"")},b.prototype.endInputTransition=function(a){a.push(new c(this.oldText,""))},b}(b);a.One=e;var f=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.nextState=function(a,d){return d>="a"&&"z">=d||d>="A"&&"Z">=d?new b(this.text+d,this.oldText):(a.push(new c(this.oldText,"")),new g(this.text,d))},b.prototype.endInputTransition=function(a){a.push(new g(this.text,""))},b}(b);a.Two=f;var g=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.nextState=function(a,b){return a.push(this),new c(this.oldText+b,"")},b.prototype.endInputTransition=function(){},b.prototype.createAtomicElement=function(a){return new LinkElement(this.text,a)},b}(b);a.Three=g}(WikiState||(WikiState={}));var TextElement=function(){function a(a){this.text=a,this.type="TEXT"}return a}(),ImageElement=function(){function a(a){this.url=a,this.type="IMAGE"}return a}(),LinkElement=function(){function a(a){this.text=a,this.type="LINK"}return a.prototype.url=function(){return"#/"+this.text},a}(),TableWikiElement=function(){function a(){this.type="TABLE",this.rows=new Array,this.maxCols=1}return a.prototype.addRow=function(a){var b=this.parseCells(a),c=new Array;_.each(b,function(a){c.push(new CellWikiElement(a))}),this.rows.push(c),b.length>this.maxCols&&(this.maxCols=b.length)},a.prototype.firstRow=function(){return this.rows[0]},a.prototype.parseCells=function(a){var b=a.substr(1),c=b.lastIndexOf("|");return b=b.substr(0,c),b.split("|")},a}(),CellWikiElement=function(){function a(a){this.cellEntry=a,this.status="IDLE",this.msg=null,this.expected=null,this.actual=null}return a}(),fitUtils=new FitUtils,Method=function(){function a(a,b){this.methodName=fitUtils.camelCase(a),this.isInput=b}return a.prototype.passInput=function(a,b){void 0===a[this.methodName]||"function"!=typeof a[this.methodName]?a[this.methodName]=b:a[this.methodName](b)},a.prototype.fetchOutput=function(a){var b;return void 0===a[this.methodName]||"function"!=typeof a[this.methodName]?void 0!==a[this.methodName]&&(b=a[this.methodName]):b=a[this.methodName](),b},a}(),PasteProcessor=function(){function a(a){this.data=this.dataFrom(a)}return a.prototype.process=function(){this.rows=new Array,this.extractRowsFrom(this.data)},a.prototype.dataFrom=function(a){var b;return a.clipboardData&&a.clipboardData.getData?b=a.clipboardData.getData("text/plain"):a.originalEvent&&a.originalEvent.clipboardData&&a.originalEvent.clipboardData.getData?b=a.originalEvent.clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text")),b},a.prototype.extractRowsFrom=function(a){var b=a.split("\n");b=this.processForMacChrome(b);for(var c=0;c<b.length;c++){for(var d=b[c],e=d.split("	"),f=0;f<e.length;f++)e[f]=e[f].trim();this.rows.push(e)}},a.prototype.processForMacChrome=function(a){var b=a;return 1==a.length&&(a=a[0].split("\r"),b=a),b},a}(),__extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},StandaloneController=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.loadData=function(){this.pageContents=fitUtils.wikiData(["This will map to a class called ShouldIBuyChaas. Each row in the table is a test.","","|should I buy chaas|","|cash in wallet|credit card|pints of chaas remaining|go to store?|","|0|no|0|no|","|10|no|0|yes|","|0|yes|0|yes|","|10|yes|0|yes|","|0|no|1|no|","|10|no|1|no|","|0|yes|1|no|","|10|yes|1|no|","","This is an example of executable documentation!","Now let's try a Query table","|Query:employees hired before|10-Dec-1980|","|company number|employee number|first name|last name|hire date|","|4808147|9942|Bill|Mitchell|19-Dec-1966|","|4808147|1429|Bob|Mastin|10-Oct-1975|","|5123122|||||","","Now, let's see a script table.","|script|login dialog driver|Bob|xyzzy|","|login with username|Bob|and password|xyzzy|","|login with username and password;|Bob|xyzzy|","|check|login message|Bob logged in.|","|reject|login with username|Bob|and password|bad password|","|check|login message|Bob not logged in.|","|check not|login message|Bob logged in.|","|ensure|login with username|Bob|and password|xyzzy|","|note|this is a comment|","|show|number of login attempts|"],mockHttp)},b}(FitController);angular.module("fitApp").controller("StandaloneController",StandaloneController),function(){angular.module("chaas").factory("CONFIG",["$q","$http",function(a,b){var c=a.defer();return b.get("/chaas.json").success(function(a){angular.extend(c.promise,a),c.resolve()}),angular.extend(c.promise,{path:function(){return _.reduce(arguments,function(a,b){return a.replace(/\/$/,"")+"/"+b})}})}])}();